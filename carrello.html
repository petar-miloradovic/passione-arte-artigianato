<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carrello — Passione Arte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="media/logo.svg" alt="logo" width="40" height="40" class="me-2">
          <span class="brand-name">Passione Arte</span>
        </a>
      </div>
    </nav>

    <main class="container py-5">
      <h1 class="h4 mb-4">Il tuo carrello</h1>

      <div id="cartArea">
        <p class="text-muted">Caricamento carrello...</p>
      </div>

      <div class="mt-4 d-flex justify-content-between align-items-center">
        <a href="index.html" class="btn btn-outline-secondary">Continua gli acquisti</a>
        <div>
          <button id="clearBtn" class="btn btn-sm btn-outline-danger me-2">Svuota carrello</button>
          <button id="checkoutBtn" class="btn btn-primary">Procedi al pagamento</button>
        </div>
      </div>
    </main>

    <footer class="py-4">
      <div class="container d-flex justify-content-between align-items-center">
        <small class="text-muted">© 2025 Passione Arte</small>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function formatCHF(v){
        return 'CHF ' + (Number(v)||0).toFixed(2);
      }

      function loadCart(){
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const area = document.getElementById('cartArea');
        if(!cart || cart.length===0){
          area.innerHTML = '<p class="text-muted">Il carrello è vuoto.</p>';
          return;
        }

        let html = '<div class="list-group">';
        cart.forEach((item, idx) => {
          // Correzione al volo per immagini Drive vecchie nel carrello
          let imgSrc = item.image;
          if(imgSrc && imgSrc.includes('drive.google.com') && !imgSrc.includes('thumbnail')){
             const match = imgSrc.match(/id=([a-zA-Z0-9_-]+)/);
             if(match && match[1]) imgSrc = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
          }

          const encodedKey = encodeURIComponent(item.titolo || '');
          html += `
            <div class="list-group-item d-flex gap-3 py-3">
              <a href="prodotto.html?key=${encodedKey}"><img src="${imgSrc}" alt="${item.titolo}" width="86" height="86" class="flex-shrink-0 rounded-2" style="object-fit:cover; background:#f8f9fa" referrerpolicy="no-referrer"></a>
              <div class="d-flex gap-2 w-100 justify-content-between">
                <div>
                  <h6 class="mb-0"><a href="prodotto.html?key=${encodedKey}" class="text-body text-decoration-none">${item.titolo}</a></h6>
                  <p class="small text-muted mb-1">${item.descrizione||''}</p>
                  <div class="small text-muted">Prezzo unitario: ${formatCHF(item.prezzo)}</div>
                </div>
                <div class="text-end">
                  <div class="d-flex align-items-center justify-content-end mb-2">
                    <input type="number" min="1" value="${item.qty||1}" data-idx="${idx}" class="form-control form-control-sm qty-input" style="width:72px">
                  </div>
                  <div class="fw-bold mb-1">${formatCHF((item.prezzo||0) * (item.qty||1))}</div>
                  <button class="btn btn-sm btn-outline-danger remove-btn" data-idx="${idx}">Rimuovi</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';

        // Totale e spedizione
        const itemsTotal = cart.reduce((s,it)=> s + (Number(it.prezzo||0) * (Number(it.qty)||0)), 0);
        // shipping: 5 CHF if at least one product and itemsTotal < 100, otherwise 0
        const shipping = (cart.length > 0 && itemsTotal < 100) ? 5 : 0;
        const grandTotal = itemsTotal + shipping;
        html += `<div class="mt-3 p-3 border rounded bg-white">
          <div class="d-flex justify-content-between"><div>Subtotale</div><div>${formatCHF(itemsTotal)}</div></div>
          <div class="d-flex justify-content-between"><div>Spedizione</div><div>${formatCHF(shipping)}</div></div>
          <hr>
          <div class="d-flex justify-content-between align-items-center"><div class="fw-semibold">Totale</div><div class="fs-5 fw-bold">${formatCHF(grandTotal)}</div></div>
          <div class="mt-2"><small class="text-muted">La spedizione è CHF 5 (gratuita per ordini pari o superiori a CHF 100).</small></div>
        </div>`;

        area.innerHTML = html;

        // Eventi
        document.querySelectorAll('.remove-btn').forEach(b=> b.addEventListener('click', (e)=>{
          const i = Number(b.getAttribute('data-idx'));
          removeItem(i);
        }));
        document.querySelectorAll('.qty-input').forEach(inp=> inp.addEventListener('change', (e)=>{
          const i = Number(inp.getAttribute('data-idx'));
          const v = Math.max(1, Number(inp.value)||1);
          updateQty(i, v);
        }));
      }

      function saveCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); }
      function removeItem(idx){
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        cart.splice(idx,1);
        saveCart(cart);
        loadCart();
      }
      function updateQty(idx, qty){
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        if(cart[idx]){ cart[idx].qty = qty; saveCart(cart); }
        loadCart();
      }

      document.getElementById('clearBtn').addEventListener('click', ()=>{
        if(confirm('Svuotare il carrello?')){
          localStorage.removeItem('cart');
          loadCart();
        }
      });

      // Configura qui l'endpoint Apps Script (web app) che popolerà il foglio `acquisti`.
      // Esempio: 'https://script.google.com/macros/s/AKfycbx.../exec'
      // Procedi al pagamento: apri la pagina `spedizione.html` che mostra il form.
      document.getElementById('checkoutBtn').addEventListener('click', ()=>{
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        if(!cart || cart.length===0){ alert('Il carrello è vuoto.'); return; }
        // apri la pagina di spedizione, i dati del carrello vengono letti da localStorage
        window.location.href = 'spedizione.html';
      });

      document.addEventListener('DOMContentLoaded', loadCart);
    </script>
  </body>
</html>
