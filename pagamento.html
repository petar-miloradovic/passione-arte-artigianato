<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pagamento — Passione Arte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <!-- Navbar semplificata -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="media/logo.svg" alt="logo" width="40" height="40" class="me-2">
          <span class="brand-name">Passione Arte</span>
        </a>
      </div>
    </nav>

    <main class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="text-center mb-4">
            <h1 class="h3">Pagamento</h1>
            <p class="text-muted">Importo totale da pagare:</p>
            <h2 class="display-4 fw-bold text-primary" id="displayTotal">CHF 0.00</h2>
          </div>

          <!-- Accordion Pagamenti -->
          <div class="accordion shadow-sm mb-4" id="paymentAccordion">
            
            <!-- TWINT -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTwint">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwint" aria-expanded="true" aria-controls="collapseTwint">
                  <strong>TWINT</strong>
                </button>
              </h2>
              <div id="collapseTwint" class="accordion-collapse collapse show" aria-labelledby="headingTwint" data-bs-parent="#paymentAccordion">
                <div class="accordion-body text-center">
                  <p class="mb-3">Invia l'importo al numero:</p>
                  <div class="alert alert-light border d-inline-block">
                    <strong id="twintNumber" class="fs-5">079 XX XX XXX</strong>
                  </div>
                  <div class="mb-3">
                    <button id="copyTwintBtn" class="btn btn-sm btn-outline-secondary">Copia numero</button>
                  </div>
                  <div class="mb-3 text-start">
                    <label for="payerNameTwint" class="form-label">Nome del pagatore (Richiesto)</label>
                    <input type="text" class="form-control" id="payerNameTwint" placeholder="Inserisci il nome" required>
                  </div>
                  <button class="btn btn-success w-100 py-2 confirm-payment-btn" data-method="TWINT">Conferma pagamento TWINT</button>
                </div>
              </div>
            </div>

            <!-- PayPal -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingPaypal">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePaypal" aria-expanded="false" aria-controls="collapsePaypal">
                  <strong>PayPal</strong>
                </button>
              </h2>
              <div id="collapsePaypal" class="accordion-collapse collapse" aria-labelledby="headingPaypal" data-bs-parent="#paymentAccordion">
                <div class="accordion-body text-center">
                  <p class="mb-3">Invia l'importo all'indirizzo email:</p>
                  <div class="alert alert-light border d-inline-block">
                    <strong id="paypalEmail" class="fs-5">aurora.giustini@gmail.com</strong>
                  </div>
                  <div class="mb-3">
                    <button id="copyPaypalBtn" class="btn btn-sm btn-outline-secondary">Copia email</button>
                  </div>
                  <div class="mb-3 text-start">
                    <label for="payerNamePaypal" class="form-label">Nome del pagatore (Richiesto)</label>
                    <input type="text" class="form-control" id="payerNamePaypal" placeholder="Inserisci il nome" required>
                  </div>
                  <button class="btn btn-primary w-100 py-2 confirm-payment-btn" data-method="PayPal">Conferma pagamento PayPal</button>
                </div>
              </div>
            </div>

          </div>

          <div class="text-center">
            <a href="spedizione.html" class="text-muted text-decoration-none">&larr; Torna ai dati di spedizione</a>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Endpoint Google Apps Script (Spostato qui da pagamento.html)
      const PURCHASE_ENDPOINT = "https://script.google.com/macros/s/AKfycbycmaO2dNdC0arOL3EX4frQHv9VcUW2ioWiF107HQt-6qQE5cZckiSiPROZWGaYCuaCcQ/exec";

      function formatCHF(v){ return 'CHF ' + (Number(v)||0).toFixed(2); }

      document.addEventListener('DOMContentLoaded', () => {
        // Recupera l'ordine pendente salvato da pagamento.html
        const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
        
        if (!pendingOrder) {
          alert('Nessun ordine trovato. Torna al carrello.');
          window.location.href = 'carrello.html';
          return;
        }

        // Mostra il totale
        document.getElementById('displayTotal').textContent = formatCHF(pendingOrder.total);

        // Gestione copia numero TWINT
        const copyBtn = document.getElementById('copyTwintBtn');
        if(copyBtn){
          copyBtn.addEventListener('click', () => {
            const number = document.getElementById('twintNumber').textContent;
            navigator.clipboard.writeText(number).then(() => {
              const originalText = copyBtn.textContent;
              copyBtn.textContent = 'Copiato!';
              copyBtn.classList.remove('btn-outline-secondary');
              copyBtn.classList.add('btn-success');
              setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
              }, 2000);
            });
          });
        }

        // Gestione copia email PayPal
        const copyPaypalBtn = document.getElementById('copyPaypalBtn');
        if(copyPaypalBtn){
          copyPaypalBtn.addEventListener('click', () => {
            const email = document.getElementById('paypalEmail').textContent;
            navigator.clipboard.writeText(email).then(() => {
              const originalText = copyPaypalBtn.textContent;
              copyPaypalBtn.textContent = 'Copiato!';
              copyPaypalBtn.classList.remove('btn-outline-secondary');
              copyPaypalBtn.classList.add('btn-success');
              setTimeout(() => {
                copyPaypalBtn.textContent = originalText;
                copyPaypalBtn.classList.remove('btn-success');
                copyPaypalBtn.classList.add('btn-outline-secondary');
              }, 2000);
            });
          });
        }

        // Gestione click pulsanti di conferma (Twint o PayPal)
        document.querySelectorAll('.confirm-payment-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const method = btn.getAttribute('data-method');
            let payerNameInput;
            
            if (method === 'TWINT') {
              payerNameInput = document.getElementById('payerNameTwint');
            } else {
              payerNameInput = document.getElementById('payerNamePaypal');
            }
            
            const payerName = payerNameInput.value.trim();

            if(!payerName) {
              alert('Per favore inserisci il Nome del pagatore.');
              payerNameInput.focus();
              return;
            }

            // Disabilita tutti i bottoni
            document.querySelectorAll('.confirm-payment-btn').forEach(b => b.disabled = true);
            
            const originalText = btn.textContent;
            btn.textContent = 'Elaborazione in corso...';

            // Aggiunge info pagamento all'ordine
            pendingOrder.paymentMethod = String(method);
            pendingOrder.payerName = String(payerName);

            try {
              // Invia i dati a Google Sheets
              const res = await fetch(PURCHASE_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(pendingOrder)
              });

              if (res.ok) {
                // Successo: pulizia carrello e ordine pendente, poi redirect
                localStorage.removeItem('cart');
                localStorage.removeItem('pendingOrder');
                alert('Grazie! Il tuo ordine è stato registrato.');
                window.location.href = 'index.html';
              } else {
                throw new Error('Risposta server non valida');
              }
            } catch (err) {
              console.error(err);
              alert('Si è verificato un errore nel salvataggio dell\'ordine. Contattaci se il problema persiste.');
              document.querySelectorAll('.confirm-payment-btn').forEach(b => b.disabled = false);
              btn.textContent = originalText;
            }
          });
        });
      });
    </script>
  </body>
</html>